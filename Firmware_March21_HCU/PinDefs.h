#ifndef PIN_DEFS_FILE
#define PIN_DEFS_FILE


#define I2C_DataPin   PB7
#define I2C_ClockPin  PB6
#define UART_RX       PA3
#define UART_TX       PA2
#define HM10_RX       PB11
#define HM10_TX       PB10
#define PASCad        PB12
#define HALLSpeed     PB3
#define GLED          PB13
#define RLED          PB14
#define MODE1         PB4
#define MODE2         PA15
#define MODE3         PA12
#define IMU_PWR       PB9
#define SD_CS         PA4
#define PPM_PIN       PB1
#define MODE_BUTTON   PB8
#define MODE_HCU      PB4
#define BOOST_HCU     PB3

//#define A_RANGE MPU6050_RANGE_16_G
//#define A_RANGE MPU6050_RANGE_8_G
//#define A_RANGE MPU6050_RANGE_4_G
#define A_RANGE MPU6050_RANGE_2_G

#define G_RANGE MPU6050_RANGE_250_DEG
//#define G_RANGE MPU6050_RANGE_500_DEG
//#define G_RANGE MPU6050_RANGE_1000_DEG
//#define G_RANGE MPU6050_RANGE_2000_DEG

//#define BW_FILTER MPU6050_BAND_260_HZ
//#define BW_FILTER MPU6050_BAND_184_HZ
//#define BW_FILTER MPU6050_BAND_94_HZ
//#define BW_FILTER MPU6050_BAND_44_HZ
//#define BW_FILTER MPU6050_BAND_21_HZ
//#define BW_FILTER MPU6050_BAND_10_HZ
#define BW_FILTER MPU6050_BAND_5_HZ

#define NUM_MODES               4
#define CAL_ADDRESS             0
#define OVERFLOW_VAL            5883676
#define OVERFLOW_32BIT          4294967296
#define CAD_THRESHOLD_US        500000 // Gotta pedal at minimum 10RPM
#define TIMER_INTERVAL_MS       500
#define POWER_TARGET            150
#define IMU_FILTER_FACTOR       10
#define GEARBOX_REDUCTION       31.2 // 31.2
#define WHEEL_CMF               2.194 //meters
#define STANDSTILL_DURATION     2500.0//ms
#define MIN_CURRENT             0.0
#define MAX_CURRENT             35.0

#define AA_START_POWER          150//W
#define AA_STANDSTILL_DURATION  1500//ms
#define AA_POWER_LIMIT          500//W
#define AA_SCALE_FACTOR         1
#define NUM_CAL_SAMPS           1024
#define WHEEL_DIST              0.07276
#define MIN_SPEED_MS            0.3// m/s
#define MIN_POWER               10.0//W
#define TORQUE_LIMIT            50.0//Nm
#define CAD_LIM                 12//rpm

/*FILRER PARAMATERS*/
//#define FIR_FILTER_LEN_LPF_ACC  518
#define FIR_FILTER_LEN_LPF_ACC    356
#define FIR_FILTER_LEN_MA_SPEED   20
#define FIR_FILTER_LEN_ACC        20
#define FIR_FILTER_LEN_EXTRA      100


//#define LPF_ACC_GAIN            1.33
#define LPF_ACC_GAIN            0.95
#define ANGLE_OFFSET            -0.73
#define BUFF_SIZE               30
#define MOD_CTR                 30

/* SWYTCH CONSTANTS */
#define SWYTCH_POWER_LIMIT      200.0//W Low Power cadance mode
#define SWYTCH_START_POWER      100.0//W
#define SWYTCH_MAX_CADENCE      100.0//RPM
#define SWYTCH_BASE_POWER       40.0//W

/* HILLS CONSTANTS */
#define HILLS_START_POWER       150.0//W
#define HILLS_SCALE_FACTOR      25.0
#define HILLS_POWER_LIMIT       300.0//W
#define HILLS_BASE_POWER        60.0//W
#define INCLINE_OFFSET          -2.0 // degrees
#define INCLINE_THRESHOLD       -2.0 // degrees
#define INCLINE_HARD_LIMIT      -4.0 // degrees
#define CADENCE_OFFSET          30.0 //RPM
#define CADENCE_SCALE_FACTOR    1.0

/* HILLS POWER CONSTANTS */
#define HILLS_POWER_START_POWER       300.0//W
#define HILLS_POWER_SCALE_FACTOR      25.0
#define HILLS_POWER_POWER_LIMIT       500.0//W
#define HILLS_POWER_BASE_POWER        120.0//W
#define INCLINE_POWER_OFFSET          -3.0 // degrees
#define INCLINE_POWER_THRESHOLD       -2.0 // degrees
#define INCLINE_POWER_HARD_LIMIT      -4.0 // degrees
#define CADENCE_POWER_OFFSET          10.0 //RPM
#define CADENCE_POWER_SCALE_FACTOR    1.0

/* HILLS SUPER CONSTANTS */
#define HILLS_SUPER_START_POWER       400.0//W
#define HILLS_SUPER_SCALE_FACTOR      45.0
#define HILLS_SUPER_POWER_LIMIT       650.0//W
#define HILLS_SUPER_BASE_POWER        150.0//W
#define INCLINE_SUPER_OFFSET          -3.0 // degrees
#define INCLINE_SUPER_THRESHOLD       -2.0 // degrees
#define INCLINE_SUPER_HARD_LIMIT      -4.0 // degrees
#define CADENCE_SUPER_OFFSET          10.0 //RPM
#define CADENCE_SUPER_SCALE_FACTOR    0.75

/* HILLS MODEL CONSTANTS */
#define HILLS_MODEL_START_POWER       300.0//W
#define MASS                          100.0//kg
#define VELOCITY                      4.17// m/s * 3.6 = km/h
#define GRAVITY                       9.81// m/s * 3.6 = km/h
#define CRR                           0.02
#define EFFICIENCY                    0.5
#define HILLS_MODEL_POWER_LIMIT       550.0//W
#define INCLINE_MODEL_THRESHOLD       -0.0 // degrees
#define INCLINE_MODEL_HARD_LIMIT      -4.0 // degrees
#define CADENCE_MODEL_OFFSET          100.0 //RPM


#define SAMPLES_TO_ADJ          25
#define MAX_PPM_STEP            15
#define MAX_I_STEP              0.1

float cadence = 0;
float wheelSpeed = 0;
bool initDone = false;
float incline;
bool standstillStart = false;
bool standstillStart_init = false;
String dataString = "";
bool Pedal = false;

//float aLPF [ FIR_FILTER_LEN_LPF_ACC ] =
//{
//0.00023494,2.7888e-05,2.9706e-05,3.1744e-05,3.3694e-05,3.5882e-05,3.7998e-05,4.0373e-05,4.2685e-05,4.5256e-05,4.7745e-05,5.0474e-05,5.3084e-05,5.5937e-05,5.869e-05,6.1783e-05,6.4826e-05,6.8233e-05,7.1188e-05,7.4668e-05,7.8179e-05,8.1704e-05,8.5368e-05,8.9157e-05,9.3011e-05,9.7045e-05,0.00010113,0.0001054,0.0001097,0.00011419,0.0001187,0.00012343,0.00012819,0.00013317,0.00013816,0.00014334,0.0001486,0.00015411,0.00015954,0.0001653,0.00017103,0.00017703,0.00018304,0.00018931,0.0001956,0.00020214,0.00020871,0.00021553,0.00022238,0.00022949,0.00023663,0.00024401,0.00025143,0.00025912,0.00026686,0.00027481,0.00028285,0.00029113,0.00029945,0.00030804,0.00031666,0.00032556,0.0003345,0.0003437,0.00035296,0.00036248,0.00037205,0.00038189,0.00039177,0.00040193,0.00041214,0.00042262,0.00043313,0.00044395,0.0004548,0.00046591,0.0004771,0.00048854,0.00050005,0.00051181,0.00052364,0.00053573,0.00054789,0.0005603,0.00057277,0.0005855,0.0005983,0.00061136,0.00062447,0.00063784,0.00065128,0.00066497,0.00067871,0.00069273,0.00070678,0.00072111,0.00073548,0.0007501,0.00076478,0.00077971,0.00079469,0.00080992,0.0008252,0.00084073,0.0008563,0.00087211,0.00088797,0.00090407,0.0009202,0.00093657,0.00095299,0.00096962,0.0009863,0.0010032,0.0010201,0.0010373,0.0010545,0.0010719,0.0010893,0.0011069,0.0011246,0.0011425,0.0011603,0.0011784,0.0011965,0.0012148,0.0012331,0.0012516,0.0012701,0.0012888,0.0013075,0.0013263,0.0013452,0.0013642,0.0013832,0.0014024,0.0014215,0.0014409,0.0014601,0.0014796,0.001499,0.0015185,0.0015381,0.0015577,0.0015773,0.001597,0.0016167,0.0016365,0.0016563,0.0016761,0.0016959,0.0017158,0.0017357,0.0017556,0.0017755,0.0017954,0.0018152,0.0018352,0.001855,0.0018749,0.0018948,0.0019146,0.0019344,0.0019542,0.0019739,0.0019937,0.0020133,0.002033,0.0020525,0.0020721,0.0020915,0.002111,0.0021303,0.0021496,0.0021687,0.0021879,0.0022069,0.0022259,0.0022447,0.0022635,0.0022821,0.0023007,0.0023191,0.0023375,0.0023557,0.0023738,0.0023917,0.0024096,0.0024273,0.0024449,0.0024623,0.0024796,0.0024967,0.0025137,0.0025305,0.0025471,0.0025636,0.0025799,0.0025961,0.002612,0.0026278,0.0026434,0.0026588,0.002674,0.002689,0.0027039,0.0027185,0.0027329,0.0027471,0.002761,0.0027748,0.0027883,0.0028016,0.0028147,0.0028275,0.0028402,0.0028525,0.0028647,0.0028765,0.0028882,0.0028996,0.0029107,0.0029216,0.0029322,0.0029425,0.0029526,0.0029624,0.002972,0.0029813,0.0029903,0.002999,0.0030075,0.0030156,0.0030235,0.0030311,0.0030384,0.0030454,0.0030521,0.0030586,0.0030647,0.0030705,0.0030761,0.0030813,0.0030863,0.0030909,0.0030952,0.0030992,0.003103,0.0031064,0.0031095,0.0031123,0.0031148,0.003117,0.0031188,0.0031204,0.0031217,0.0031226,0.0031232,0.0031235,0.0031235,0.0031232,0.0031226,0.0031217,0.0031204,0.0031188,0.003117,0.0031148,0.0031123,0.0031095,0.0031064,0.003103,0.0030992,0.0030952,0.0030909,0.0030863,0.0030813,0.0030761,0.0030705,0.0030647,0.0030586,0.0030521,0.0030454,0.0030384,0.0030311,0.0030235,0.0030156,0.0030075,0.002999,0.0029903,0.0029813,0.002972,0.0029624,0.0029526,0.0029425,0.0029322,0.0029216,0.0029107,0.0028996,0.0028882,0.0028765,0.0028647,0.0028525,0.0028402,0.0028275,0.0028147,0.0028016,0.0027883,0.0027748,0.002761,0.0027471,0.0027329,0.0027185,0.0027039,0.002689,0.002674,0.0026588,0.0026434,0.0026278,0.002612,0.0025961,0.0025799,0.0025636,0.0025471,0.0025305,0.0025137,0.0024967,0.0024796,0.0024623,0.0024449,0.0024273,0.0024096,0.0023917,0.0023738,0.0023557,0.0023375,0.0023191,0.0023007,0.0022821,0.0022635,0.0022447,0.0022259,0.0022069,0.0021879,0.0021687,0.0021496,0.0021303,0.002111,0.0020915,0.0020721,0.0020525,0.002033,0.0020133,0.0019937,0.0019739,0.0019542,0.0019344,0.0019146,0.0018948,0.0018749,0.001855,0.0018352,0.0018152,0.0017954,0.0017755,0.0017556,0.0017357,0.0017158,0.0016959,0.0016761,0.0016563,0.0016365,0.0016167,0.001597,0.0015773,0.0015577,0.0015381,0.0015185,0.001499,0.0014796,0.0014601,0.0014409,0.0014215,0.0014024,0.0013832,0.0013642,0.0013452,0.0013263,0.0013075,0.0012888,0.0012701,0.0012516,0.0012331,0.0012148,0.0011965,0.0011784,0.0011603,0.0011425,0.0011246,0.0011069,0.0010893,0.0010719,0.0010545,0.0010373,0.0010201,0.0010032,0.0009863,0.00096962,0.00095299,0.00093657,0.0009202,0.00090407,0.00088797,0.00087211,0.0008563,0.00084073,0.0008252,0.00080992,0.00079469,0.00077971,0.00076478,0.0007501,0.00073548,0.00072111,0.00070678,0.00069273,0.00067871,0.00066497,0.00065128,0.00063784,0.00062447,0.00061136,0.0005983,0.0005855,0.00057277,0.0005603,0.00054789,0.00053573,0.00052364,0.00051181,0.00050005,0.00048854,0.0004771,0.00046591,0.0004548,0.00044395,0.00043313,0.00042262,0.00041214,0.00040193,0.00039177,0.00038189,0.00037205,0.00036248,0.00035296,0.0003437,0.0003345,0.00032556,0.00031666,0.00030804,0.00029945,0.00029113,0.00028285,0.00027481,0.00026686,0.00025912,0.00025143,0.00024401,0.00023663,0.00022949,0.00022238,0.00021553,0.00020871,0.00020214,0.0001956,0.00018931,0.00018304,0.00017703,0.00017103,0.0001653,0.00015954,0.00015411,0.0001486,0.00014334,0.00013816,0.00013317,0.00012819,0.00012343,0.0001187,0.00011419,0.0001097,0.0001054,0.00010113,9.7045e-05,9.3011e-05,8.9157e-05,8.5368e-05,8.1704e-05,7.8179e-05,7.4668e-05,7.1188e-05,6.8233e-05,6.4826e-05,6.1783e-05,5.869e-05,5.5937e-05,5.3084e-05,5.0474e-05,4.7745e-05,4.5256e-05,4.2685e-05,4.0373e-05,3.7998e-05,3.5882e-05,3.3694e-05,3.1744e-05,2.9706e-05,2.7888e-05,0.00023494
//};

float aMA [ FIR_FILTER_LEN_MA_SPEED ] =
{
  0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05
};

float extraMA [ FIR_FILTER_LEN_EXTRA ] =
{
  0.01, 0.01, 0.01, 0.01, 0.01,0.01, 0.01, 0.01, 0.01, 0.01,0.01, 0.01, 0.01, 0.01, 0.01,0.01, 0.01, 0.01, 0.01, 0.01,0.01, 0.01, 0.01, 0.01, 0.01,0.01, 0.01, 0.01, 0.01, 0.01,0.01, 0.01, 0.01, 0.01, 0.01,0.01, 0.01, 0.01, 0.01, 0.01,0.01, 0.01, 0.01, 0.01, 0.01,0.01, 0.01, 0.01, 0.01, 0.01,0.01, 0.01, 0.01, 0.01, 0.01,0.01, 0.01, 0.01, 0.01, 0.01,0.01, 0.01, 0.01, 0.01, 0.01,0.01, 0.01, 0.01, 0.01, 0.01,0.01, 0.01, 0.01, 0.01, 0.01,0.01, 0.01, 0.01, 0.01, 0.01,0.01, 0.01, 0.01, 0.01, 0.01,0.01, 0.01, 0.01, 0.01, 0.01,0.01, 0.01, 0.01, 0.01, 0.01,0.01, 0.01, 0.01, 0.01, 0.01,
};

float accMA [ FIR_FILTER_LEN_ACC] =
{
0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05
};


float aLPF [ FIR_FILTER_LEN_LPF_ACC ] =
{
-9.2534e-05,2.2718e-06,2.5707e-06,3.0652e-06,3.7838e-06,4.6998e-06,5.8459e-06,7.1967e-06,8.7898e-06,1.06e-05,1.2671e-05,1.4974e-05,1.7561e-05,2.0399e-05,2.3548e-05,2.6969e-05,3.0735e-05,3.4789e-05,3.9236e-05,4.3958e-05,4.9184e-05,5.4766e-05,6.0607e-05,6.6992e-05,7.377e-05,8.1043e-05,8.8763e-05,9.6999e-05,0.00010573,0.000115,0.00012481,0.0001352,0.00014617,0.00015776,0.00016996,0.00018282,0.00019634,0.00021056,0.00022547,0.00024112,0.00025753,0.00027465,0.00029261,0.00031137,0.00033095,0.00035138,0.00037267,0.00039485,0.00041792,0.00044193,0.00046686,0.00049277,0.00051963,0.0005475,0.00057637,0.00060627,0.0006372,0.0006692,0.00070225,0.0007364,0.00077163,0.00080798,0.00084546,0.00088405,0.00092379,0.00096467,0.0010067,0.0010499,0.0010943,0.0011399,0.0011866,0.0012346,0.0012837,0.001334,0.0013855,0.0014382,0.0014921,0.0015472,0.0016034,0.0016609,0.0017195,0.0017793,0.0018402,0.0019023,0.0019655,0.0020298,0.0020953,0.0021618,0.0022294,0.0022981,0.0023679,0.0024386,0.0025104,0.0025831,0.0026568,0.0027314,0.0028069,0.0028833,0.0029605,0.0030386,0.0031174,0.003197,0.0032773,0.0033583,0.0034399,0.0035222,0.003605,0.0036883,0.0037721,0.0038564,0.003941,0.0040261,0.0041114,0.004197,0.0042829,0.0043689,0.004455,0.0045412,0.0046275,0.0047137,0.0047998,0.0048858,0.0049717,0.0050573,0.0051426,0.0052276,0.0053121,0.0053963,0.0054799,0.005563,0.0056455,0.0057273,0.0058084,0.0058887,0.0059682,0.0060468,0.0061244,0.0062011,0.0062767,0.0063512,0.0064246,0.0064967,0.0065676,0.0066372,0.0067055,0.0067723,0.0068377,0.0069015,0.0069638,0.0070245,0.0070836,0.007141,0.0071966,0.0072505,0.0073025,0.0073527,0.007401,0.0074474,0.0074918,0.0075342,0.0075745,0.0076128,0.007649,0.0076831,0.0077151,0.0077448,0.0077724,0.0077977,0.0078208,0.0078417,0.0078602,0.0078765,0.0078905,0.0079021,0.0079115,0.0079185,0.0079232,0.0079255,0.0079255,0.0079232,0.0079185,0.0079115,0.0079021,0.0078905,0.0078765,0.0078602,0.0078417,0.0078208,0.0077977,0.0077724,0.0077448,0.0077151,0.0076831,0.007649,0.0076128,0.0075745,0.0075342,0.0074918,0.0074474,0.007401,0.0073527,0.0073025,0.0072505,0.0071966,0.007141,0.0070836,0.0070245,0.0069638,0.0069015,0.0068377,0.0067723,0.0067055,0.0066372,0.0065676,0.0064967,0.0064246,0.0063512,0.0062767,0.0062011,0.0061244,0.0060468,0.0059682,0.0058887,0.0058084,0.0057273,0.0056455,0.005563,0.0054799,0.0053963,0.0053121,0.0052276,0.0051426,0.0050573,0.0049717,0.0048858,0.0047998,0.0047137,0.0046275,0.0045412,0.004455,0.0043689,0.0042829,0.004197,0.0041114,0.0040261,0.003941,0.0038564,0.0037721,0.0036883,0.003605,0.0035222,0.0034399,0.0033583,0.0032773,0.003197,0.0031174,0.0030386,0.0029605,0.0028833,0.0028069,0.0027314,0.0026568,0.0025831,0.0025104,0.0024386,0.0023679,0.0022981,0.0022294,0.0021618,0.0020953,0.0020298,0.0019655,0.0019023,0.0018402,0.0017793,0.0017195,0.0016609,0.0016034,0.0015472,0.0014921,0.0014382,0.0013855,0.001334,0.0012837,0.0012346,0.0011866,0.0011399,0.0010943,0.0010499,0.0010067,0.00096467,0.00092379,0.00088405,0.00084546,0.00080798,0.00077163,0.0007364,0.00070225,0.0006692,0.0006372,0.00060627,0.00057637,0.0005475,0.00051963,0.00049277,0.00046686,0.00044193,0.00041792,0.00039485,0.00037267,0.00035138,0.00033095,0.00031137,0.00029261,0.00027465,0.00025753,0.00024112,0.00022547,0.00021056,0.00019634,0.00018282,0.00016996,0.00015776,0.00014617,0.0001352,0.00012481,0.000115,0.00010573,9.6999e-05,8.8763e-05,8.1043e-05,7.377e-05,6.6992e-05,6.0607e-05,5.4766e-05,4.9184e-05,4.3958e-05,3.9236e-05,3.4789e-05,3.0735e-05,2.6969e-05,2.3548e-05,2.0399e-05,1.7561e-05,1.4974e-05,1.2671e-05,1.06e-05,8.7898e-06,7.1967e-06,5.8459e-06,4.6998e-06,3.7838e-06,3.0652e-06,2.5707e-06,2.2718e-06,-9.2534e-05
};

//float aLPF [ FIR_FILTER_LEN_LPF_ACC ] =
//{
//-0.00013525,-3.5283e-05,-3.8876e-05,-4.1926e-05,-4.4243e-05,-4.5623e-05,-4.5833e-05,-4.4618e-05,-4.1684e-05,-3.6696e-05,-2.9302e-05,-1.9151e-05,-5.8995e-06,1.0841e-05,3.1546e-05,5.6753e-05,8.6874e-05,0.00012219,0.00016364,0.00021137,0.00026608,0.00032827,0.00039847,0.00047723,0.00056511,0.00066262,0.00077029,0.00088863,0.0010181,0.0011593,0.0013125,0.0014782,0.0016568,0.0018487,0.0020539,0.002273,0.0025059,0.002753,0.0030142,0.0032895,0.003579,0.0038825,0.0041998,0.0045307,0.0048748,0.0052317,0.0056009,0.0059819,0.006374,0.0067765,0.0071886,0.0076095,0.0080382,0.0084736,0.0089149,0.0093607,0.00981,0.010261,0.010714,0.011166,0.011616,0.012063,0.012506,0.012942,0.013371,0.013791,0.014201,0.014599,0.014984,0.015354,0.015709,0.016046,0.016365,0.016664,0.016943,0.0172,0.017434,0.017645,0.017831,0.017991,0.018126,0.018235,0.018317,0.018371,0.018399,0.018399,0.018371,0.018317,0.018235,0.018126,0.017991,0.017831,0.017645,0.017434,0.0172,0.016943,0.016664,0.016365,0.016046,0.015709,0.015354,0.014984,0.014599,0.014201,0.013791,0.013371,0.012942,0.012506,0.012063,0.011616,0.011166,0.010714,0.010261,0.00981,0.0093607,0.0089149,0.0084736,0.0080382,0.0076095,0.0071886,0.0067765,0.006374,0.0059819,0.0056009,0.0052317,0.0048748,0.0045307,0.0041998,0.0038825,0.003579,0.0032895,0.0030142,0.002753,0.0025059,0.002273,0.0020539,0.0018487,0.0016568,0.0014782,0.0013125,0.0011593,0.0010181,0.00088863,0.00077029,0.00066262,0.00056511,0.00047723,0.00039847,0.00032827,0.00026608,0.00021137,0.00016364,0.00012219,8.6874e-05,5.6753e-05,3.1546e-05,1.0841e-05,-5.8995e-06,-1.9151e-05,-2.9302e-05,-3.6696e-05,-4.1684e-05,-4.4618e-05,-4.5833e-05,-4.5623e-05,-4.4243e-05,-4.1926e-05,-3.8876e-05,-3.5283e-05,-0.00013525
//};
#endif
